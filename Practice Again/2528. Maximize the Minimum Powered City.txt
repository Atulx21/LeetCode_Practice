#include <vector>
#include <numeric>
#include <algorithm>

using namespace std;

class Solution {
public:
    long long maxPower(vector<int>& stations, int r, int k) {
        int n = stations.size();
        vector<long long> power_diff(n + 1, 0);
        for (int i = 0; i < n; ++i) {
            int left = max(0, i - r);
            int right = min(n - 1, i + r);
            power_diff[left] += stations[i];
            power_diff[right + 1] -= stations[i];
        }

        vector<long long> initial_power(n);
        long long current_power = 0;
        long long min_initial_power = -1;

        for (int i = 0; i < n; ++i) {
            current_power += power_diff[i];
            initial_power[i] = current_power;
            if (min_initial_power == -1 || initial_power[i] < min_initial_power) {
                min_initial_power = initial_power[i];
            }
        }

        auto can = [&](long long x) {
            vector<long long> add(n + 1, 0);
            long long used = 0, curr = 0;
            int windowSize = 2 * r + 1;
            for (int i = 0; i < n; ++i) {
                curr += add[i];
                long long totalPower = initial_power[i] + curr;
                if (totalPower < x) {
                    long long need = x - totalPower;
                    used += need;
                    if (used > k) return false;
                    curr += need;
                    int pos = i + windowSize;
                    if (pos < n) add[pos] -= need;
                }
            }
            return true;
        };

        long long lo = 0, hi = min_initial_power + k;
        long long ans = 0;
        
        while (lo <= hi) {
            long long mid = lo + (hi - lo) / 2;
            if (can(mid)) {
                ans = mid;
                lo = mid + 1;
            } else {
                hi = mid - 1;
            }
        }
        return ans;
    }
};


Example 1:
Input: stations = [1,2,4,5,0], r = 1, k = 2
Output: 5


Example 2:
Input: stations = [4,4,4,4], r = 0, k = 3
Output: 4